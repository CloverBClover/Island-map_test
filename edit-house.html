<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit House</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      background-color: #111;
      overflow: hidden;
      user-select: none;
    }
    #house-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-size: cover;
      background-position: center;
      overflow: hidden;
      z-index: 1;
    }
    .furniture-item {
      position: absolute;
      width: 100px; /* fixed size */
      height: auto;
      cursor: move;
      transition: box-shadow 0.2s;
      user-select: none;
    }
    .furniture-item.dragging {
      box-shadow: 0 0 10px 3px #00aaff;
      opacity: 0.8;
    }
    /* Remove button inside furniture */
    .remove-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(255,0,0,0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-weight: bold;
      font-size: 16px;
      line-height: 16px;
      cursor: pointer;
      user-select: none;
      display: none;
      z-index: 10;
    }
    .furniture-item:hover .remove-btn {
      display: block;
    }
    #ui-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 220px;
      background: rgba(0,0,0,0.85);
      padding: 15px;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      z-index: 10; /* higher than house/furniture */
    }
    #ui-panel h3 {
      margin-top: 0;
    }
    #ui-panel button, #ui-panel select {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    #ui-panel button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    #ui-panel select {
      background: #222;
      color: white;
    }
  </style>
</head>
<body>
  <div id="house-container"></div>

  <div id="ui-panel">
    <h3>Your Furniture</h3>
    <div id="furniture-buttons"></div>

    <h3>House Style</h3>
    <select id="house-style-select">
      <option value="house1">House 1</option>
      <option value="house2">House 2</option>
      <option value="house3">House 3</option>
    </select>

    <button id="save-btn">Save Changes</button>
    <button id="back-btn">Back to Island</button>
  </div>

<script>
  const houseContainer = document.getElementById('house-container');
  const furnitureButtonsDiv = document.getElementById('furniture-buttons');
  const houseStyleSelect = document.getElementById('house-style-select');
  const saveBtn = document.getElementById('save-btn');
  const backBtn = document.getElementById('back-btn');

  // Load logged in user
  let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
  if (!loggedInUser) {
    alert("You must be logged in to edit your house.");
    window.location.href = "index.html";
  }

  // Defaults for missing data
  loggedInUser.houseStyle = loggedInUser.houseStyle || "house1";
  loggedInUser.inventory = loggedInUser.inventory || { furniture: {} };
  loggedInUser.furniturePositions = loggedInUser.furniturePositions || {};
  loggedInUser.placedFurniture = {}; // We'll track counts here fresh each load

  // Set house background & select box
  function updateHouseBackground() {
    houseContainer.style.backgroundImage = `url('images/${loggedInUser.houseStyle}.png')`;
    houseStyleSelect.value = loggedInUser.houseStyle;
  }

  updateHouseBackground();

  // --- Drag variables ---
  let dragItem = null;
  let offsetX = 0;
  let offsetY = 0;

  // Save changes to localStorage
  function saveUserData() {
    localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
    let allUsers = JSON.parse(localStorage.getItem('users')) || [];
    allUsers = allUsers.map(u => u.username === loggedInUser.username ? loggedInUser : u);
    localStorage.setItem('users', JSON.stringify(allUsers));
    alert('Changes saved!');
  }

  // Furniture count helper
  function countPlacedFurniture() {
    loggedInUser.placedFurniture = {};
    for (const furn in loggedInUser.furniturePositions) {
      loggedInUser.placedFurniture[furn] = loggedInUser.furniturePositions[furn].length;
    }
  }

  // Render furniture buttons, disable those fully placed
  function renderFurnitureButtons() {
    furnitureButtonsDiv.innerHTML = "";
    const inv = loggedInUser.inventory.furniture;
    countPlacedFurniture();

    for (const furn in inv) {
      const owned = inv[furn];
      const placed = loggedInUser.placedFurniture[furn] || 0;
      const available = owned - placed;

      const btn = document.createElement('button');
      btn.textContent = `${furn} (${available} available)`;
      btn.disabled = available <= 0;

      btn.onclick = () => placeFurniture(furn);

      furnitureButtonsDiv.appendChild(btn);
    }
  }

  // Place furniture at default pos
  function placeFurniture(furnName, x = 50, y = 50) {
    const owned = loggedInUser.inventory.furniture[furnName] || 0;
    const placed = loggedInUser.placedFurniture[furnName] || 0;

    if (placed >= owned) {
      alert(`No more ${furnName} available to place.`);
      return;
    }

    if (!loggedInUser.furniturePositions[furnName]) {
      loggedInUser.furniturePositions[furnName] = [];
    }
    loggedInUser.furniturePositions[furnName].push({ x, y });
    countPlacedFurniture();
    renderPlacedFurniture();
    renderFurnitureButtons();
  }

  // Remove furniture by furniture name and index
  function removeFurniture(furnName, index) {
    if (!loggedInUser.furniturePositions[furnName]) return;
    loggedInUser.furniturePositions[furnName].splice(index, 1);
    if (loggedInUser.furniturePositions[furnName].length === 0) {
      delete loggedInUser.furniturePositions[furnName];
    }
    countPlacedFurniture();
    renderPlacedFurniture();
    renderFurnitureButtons();
  }

  // Render all furniture items from positions
  function renderPlacedFurniture() {
    houseContainer.innerHTML = ""; // Clear all

    for (const furn in loggedInUser.furniturePositions) {
      const positions = loggedInUser.furniturePositions[furn];
      positions.forEach((pos, i) => {
        const img = document.createElement('div');
        img.style.position = "absolute";
        img.style.left = pos.x + 'px';
        img.style.top = pos.y + 'px';
        img.style.width = "100px";
        img.style.cursor = "move";
        img.style.userSelect = "none";

        const imgElem = document.createElement('img');
        imgElem.src = `images/furniture/${furn}.png`;
        imgElem.style.width = "100%";
        imgElem.draggable = false;
        imgElem.className = "furniture-item";
        img.appendChild(imgElem);

        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.textContent = "×";
        removeBtn.className = "remove-btn";
        removeBtn.title = "Remove furniture";
        removeBtn.onclick = (e) => {
          e.stopPropagation(); // Prevent drag start
          removeFurniture(furn, i);
        };
        img.appendChild(removeBtn);

        // Drag handlers
        img.onmousedown = (e) => {
          dragItem = img;
          offsetX = e.clientX - img.offsetLeft;
          offsetY = e.clientY - img.offsetTop;
          img.classList.add('dragging');
        };
        houseContainer.appendChild(img);
      });
    }
  }

  // Drag & drop logic
  document.addEventListener('mouseup', (e) => {
    if (dragItem) {
      dragItem.classList.remove('dragging');

      // Update position in furniturePositions
      const left = parseInt(dragItem.style.left);
      const top = parseInt(dragItem.style.top);

      // Find which furniture and index by matching element
      let found = false;
      for (const furn in loggedInUser.furniturePositions) {
        const positions = loggedInUser.furniturePositions[furn];
        for (let i = 0; i < positions.length; i++) {
          // To match, we can check offset & size — but better to find matching by order.
          // Let's get all img elements inside houseContainer for this furn
          const elems = [...houseContainer.querySelectorAll('div')].filter(d => {
            return d.querySelector('img').src.includes(furn);
          });
          if (elems[i] === dragItem) {
            // Update position
            // Clamp position inside house container boundaries
            let newX = Math.min(Math.max(0, left), houseContainer.clientWidth - dragItem.clientWidth);
            let newY = Math.min(Math.max(0, top), houseContainer.clientHeight - dragItem.clientHeight);

            loggedInUser.furniturePositions[furn][i] = { x: newX, y: newY };
            found = true;
            break;
          }
        }
        if (found) break;
      }

      dragItem = null;
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (dragItem) {
      let x = e.clientX - offsetX;
      let y = e.clientY - offsetY;

      // Clamp within house container
      x = Math.min(Math.max(0, x), houseContainer.clientWidth - dragItem.clientWidth);
      y = Math.min(Math.max(0, y), houseContainer.clientHeight - dragItem.clientHeight);

      dragItem.style.left = x + 'px';
      dragItem.style.top = y + 'px';
    }
  });

  // Change house style handler
  houseStyleSelect.onchange = () => {
    loggedInUser.houseStyle = houseStyleSelect.value;
    updateHouseBackground();
  };

  // Save button click
  saveBtn.onclick = () => {
    saveUserData();
  };

  // Back button (adjust URL as needed)
  backBtn.onclick = () => {
    window.location.href = "island.html";
  };

  // Initial renders
  renderFurnitureButtons();
  renderPlacedFurniture();

</script>
</body>
</html>
