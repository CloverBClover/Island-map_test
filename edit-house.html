<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit House</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      background-color: black;
      overflow: hidden;
    }
    #house-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-size: cover;
      background-position: center;
      overflow: hidden;
    }
    .furniture-item {
      position: absolute;
      width: 80px;
      height: auto;
      cursor: move;
      user-select: none;
      transition: box-shadow 0.2s;
    }
    .furniture-item.dragging {
      box-shadow: 0 0 10px 3px #00aaff;
      opacity: 0.8;
    }
    #furniture-list {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 10px;
      color: white;
      max-width: 200px;
      font-size: 14px;
      z-index: 1000;
    }
    #furniture-list button {
      margin-top: 8px;
      padding: 8px;
      width: 100%;
      background: #0077cc;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    #furniture-list button:disabled {
      background: #444;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="house-container"></div>
  <div id="furniture-list">
    <h3>Your Furniture</h3>
    <!-- Furniture buttons populated here -->
  </div>

<script>
  const houseContainer = document.getElementById('house-container');
  const furnitureListDiv = document.getElementById('furniture-list');

  // Load logged in user
  let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
  if (!loggedInUser) {
    alert("You must be logged in to edit your house.");
    window.location.href = "index.html";
  }

  // Set house background
  houseContainer.style.backgroundImage = `url('images/${loggedInUser.houseStyle || "house1"}.png')`;

  // Ensure placedFurniture and furniturePositions exist
  loggedInUser.placedFurniture = loggedInUser.placedFurniture || {};
  loggedInUser.furniturePositions = loggedInUser.furniturePositions || {};

  // For drag & drop tracking
  let dragItem = null;
  let offsetX = 0;
  let offsetY = 0;

  // Save changes to localStorage (both loggedInUser and allUsers)
  function saveUserData() {
    localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
    let allUsers = JSON.parse(localStorage.getItem('users')) || [];
    allUsers = allUsers.map(u => u.username === loggedInUser.username ? loggedInUser : u);
    localStorage.setItem('users', JSON.stringify(allUsers));
  }

  // Create furniture buttons in panel
  function createFurnitureButtons() {
    furnitureListDiv.innerHTML = '<h3>Your Furniture</h3>';
    const inventory = loggedInUser.inventory?.furniture || {};
    for (const furn in inventory) {
      const ownedCount = inventory[furn];
      const placedCount = loggedInUser.placedFurniture[furn] || 0;
      const availableCount = ownedCount - placedCount;

      const btn = document.createElement('button');
      btn.textContent = `${furn} (${availableCount} available)`;
      btn.disabled = availableCount <= 0;

      btn.addEventListener('click', () => {
        placeFurniture(furn);
      });
      furnitureListDiv.appendChild(btn);
    }
  }

  // Place furniture visually and update counts
  function placeFurniture(furnName, x = 50, y = 50) {
    const inventoryCount = loggedInUser.inventory?.furniture[furnName] || 0;
    const placedCount = loggedInUser.placedFurniture[furnName] || 0;

    if (placedCount >= inventoryCount) {
      alert(`You cannot place more ${furnName} than you own!`);
      return;
    }

    // Create image element
    const img = document.createElement('img');
    img.src = `images/furniture/${furnName}.png`;
    img.className = 'furniture-item';
    img.style.left = x + 'px';
    img.style.top = y + 'px';
    img.draggable = false; // We'll handle dragging manually

    // Store furniture name on element dataset for easy reference
    img.dataset.furnName = furnName;

    // Add event listeners for drag & drop
    img.addEventListener('mousedown', dragStart);
    document.addEventListener('mouseup', dragEnd);
    document.addEventListener('mousemove', dragMove);

    houseContainer.appendChild(img);

    // Update counts
    loggedInUser.placedFurniture[furnName] = placedCount + 1;
    // Store position in furniturePositions for this furniture piece
    // We'll use an array for positions of each furniture type
    loggedInUser.furniturePositions[furnName] = loggedInUser.furniturePositions[furnName] || [];
    loggedInUser.furniturePositions[furnName].push({ x, y });

    saveUserData();
    createFurnitureButtons();
  }

  // Render all placed furniture from positions saved
  function renderPlacedFurniture() {
    houseContainer.querySelectorAll('.furniture-item').forEach(el => el.remove());

    for (const furn in loggedInUser.furniturePositions) {
      const positions = loggedInUser.furniturePositions[furn];
      positions.forEach(pos => {
        const img = document.createElement('img');
        img.src = `images/furniture/${furn}.png`;
        img.className = 'furniture-item';
        img.style.left = pos.x + 'px';
        img.style.top = pos.y + 'px';
        img.draggable = false;
        img.dataset.furnName = furn;

        img.addEventListener('mousedown', dragStart);
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('mousemove', dragMove);

        houseContainer.appendChild(img);
      });
    }
  }

  // Drag & Drop handlers
  function dragStart(e) {
    if (e.target.classList.contains('furniture-item')) {
      dragItem = e.target;
      offsetX = e.clientX - dragItem.offsetLeft;
      offsetY = e.clientY - dragItem.offsetTop;
      dragItem.classList.add('dragging');
    }
  }

  function dragMove(e) {
    if (dragItem) {
      let x = e.clientX - offsetX;
      let y = e.clientY - offsetY;

      // Limit drag within house container bounds
      x = Math.max(0, Math.min(x, houseContainer.clientWidth - dragItem.clientWidth));
      y = Math.max(0, Math.min(y, houseContainer.clientHeight - dragItem.clientHeight));

      dragItem.style.left = x + 'px';
      dragItem.style.top = y + 'px';
    }
  }

  function dragEnd(e) {
    if (dragItem) {
      dragItem.classList.remove('dragging');

      // Update stored position in furniturePositions array
      const furnName = dragItem.dataset.furnName;
      const left = parseInt(dragItem.style.left, 10);
      const top = parseInt(dragItem.style.top, 10);

      // Find the matching furniture position entry and update it
      // Because we add furniture in order, the element index corresponds to index in array
      const images = [...houseContainer.querySelectorAll(`.furniture-item[data-furn-name="${furnName}"]`)];
      const idx = images.indexOf(dragItem);
      if (idx !== -1 && loggedInUser.furniturePositions[furnName]) {
        loggedInUser.furniturePositions[furnName][idx] = { x: left, y: top };
        saveUserData();
      }

      dragItem = null;
    }
  }

  createFurnitureButtons();
  renderPlacedFurniture();
</script>
</body>
</html>
